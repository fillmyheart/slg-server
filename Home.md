# 1 ç®€ä»‹
---
è¿™æ˜¯ä¸€ç¯‡æè¿°erlangæ¸¸æˆæœåŠ¡å™¨è®¾è®¡çš„æ–‡ç« ã€‚

ä¸€å¹´å‰æˆ‘å­¦ä¹ erlangçš„æ—¶å€™ï¼Œç½‘ä¸Šå¯ä»¥è·å–åˆ°çš„ä¹¦ç±éå¸¸å°‘ï¼Œå­¦ä¹ çš„æ—¶å€™èµ°äº†ä¸å°‘å¼¯è·¯ï¼Œè€Œå¦‚ä»Šæˆ‘å·²ç»å¯¹erlangæ¸¸æˆæœåŠ¡å™¨ç¼–ç¨‹æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œæ‰€ä»¥æˆ‘æƒ³æŠŠè¿™äº›è®¾è®¡ç»éªŒå’Œerlangç›¸å…³çš„çŸ¥è¯†å†™ä¸‹æ¥ï¼Œä¸€æ–¹é¢å‡å°‘æ–°æ‰‹å­¦ä¹ erlangçš„ç—›è‹¦ï¼Œå¦ä¸€æ–¹é¢ä¸ºè‡ªå·±å¤‡ä¸ªæ¡ˆï¼Œç„¶åå°±æ˜¯ç»™å¤§å®¶reviewï¼Œä»¥ä¾¿ä¸æ–­æ”¹è¿›å®ƒã€‚

æœ¬æ–‡æ˜¯ç»“åˆæˆ‘è‡ªå·±çš„é¡¹ç›®[slg-server](https://github.com/zhuoyikang/slg-server)æ¥æè¿°çš„ï¼Œå½“ç„¶æˆ‘éå¸¸æ¬¢è¿æ‚¨é˜…è¯»æˆ‘çš„ä»£ç æˆ–è€…æå‡ºä¿®æ”¹æ„è§ã€‚

slg-serverä¸ä½¿ç”¨åˆ†å¸ƒå¼erlangï¼ŒæŒ‰ç…§ç°åœ¨æ¸¸æˆç•Œæ¯”è¾ƒæµè¡Œçš„åšæ³•ï¼šä¸€ä¸ªé€»è¾‘æœåŠ¡å™¨è´Ÿè½½å¤§æ¦‚å‡ Wäººï¼ŒåŒæ—¶åœ¨çº¿äººæ•°å‡ åƒäººï¼Œå¦‚æœäººæ•°å¤šäº†ï¼Œé€šè¿‡ä¸æ–­çš„å¼€æ–°æœæ¥ç¼“è§£å‹åŠ›ï¼Œæ‰€ä»¥æœ¬æ–‡æ˜¯é’ˆå¯¹è¿™ç§å°æœçš„æ¸¸æˆæœåŠ¡å™¨æ¥è®¨è®ºã€‚

## 1.1 ç»¼è¿°
---

ä¸€ä¸ªæ¸¸æˆæœåŠ¡å™¨çš„è®¾è®¡éœ€è¦åŒ…å«å“ªäº›æ¨¡å—ï¼Œæˆ‘è§‰å¾—å¤§æ¦‚æœ‰ä»¥ä¸‹å››ä¸ªéƒ¨åˆ†ï¼š

* *è¿æ¥å¤„ç†(slg-proto)*: å®¢æˆ·ç«¯é€šè¿‡tcpå’ŒæœåŠ¡å™¨å»ºç«‹è¿æ¥é€šä¿¡ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªè¿æ¥å¤„ç†ï¼›æ—¢ç„¶è¦é€šä¿¡ï¼Œå½“ç„¶å¿…é¡»è¦å®šä¹‰é€šä¿¡åè®®ï¼Œè¿™æ˜¯ç¬¬äºŒéƒ¨åˆ†ï¼Œç„¶åå°±æ˜¯ä¼ è¾“å†…å®¹çš„åŠ å¯†ï¼Œè¿™ä¸‰éƒ¨åˆ†å®Œæˆï¼Œè¿æ¥å¤„ç†åŸºæœ¬å°±æå®šäº†ã€‚
* *æ•°æ®å¤„ç†(slg-model)*ï¼šä¸€ä¸ªç©å®¶çš„æ•°æ®æ˜¯æ¸¸æˆä¸­æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œä¸€èˆ¬é‡‡ç”¨MySqlå­˜å‚¨ï¼Œå¦ä¸€æ–¹é¢MySqlçš„æ“ä½œé€Ÿåº¦å¤ªæ…¢ï¼Œéœ€è¦å°†ç©å®¶æ•°æ®åŠ è½½åˆ°å†…å®¹ä¸­ï¼Œä½¿å¾—ç»å¤§å¤šæ•°æ“ä½œéƒ½åœ¨å†…å­˜ä¸­ç›´æ¥è¿›è¡Œï¼Œç„¶åå†å¼‚æ­¥çš„å›å†™åˆ°MySqlæŒä¹…åŒ–ã€‚
* *é…ç½®å¤„ç†(slg-csv)*ï¼šæ¯ä¸ªæ¸¸æˆæœåŠ¡å™¨ä¸­éƒ½æœ‰å¤§é‡çš„gdé…ç½®æ–‡ä»¶ï¼Œä¸€èˆ¬éƒ½æ˜¯Excelæ ¼å¼ï¼Œå½“ç„¶erlangä¸èƒ½ç›´æ¥å¤„ç†ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥è¦å…ˆæŠŠexcelå¯¼å‡ºä¸ºcsvæ ¼å¼ï¼Œæˆ‘ä½¿ç”¨pythonå¤„ç†ï¼›å¦ä¸€éƒ¨åˆ†æŠŠcsvç›´æ¥æ˜ å°„åˆ°etsè¡¨ï¼Œç„¶åç¼–ç¨‹çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥é€šè¿‡è®¿é—®etsæ¥è®¿é—®gdé…ç½®çš„å†…å®¹äº†ã€‚
* *å…¶ä»–(slg-support)*ï¼šä¸ç®¡æ˜¯æ¸¸æˆæœåŠ¡å™¨è¿˜æ˜¯erlangæœ¬èº«éƒ½æœ‰äº›å¥½ç”¨çš„å·¥å…·å’Œå¯å¤ç”¨çš„ç¼–ç¨‹æ¨¡å—ï¼Œæˆ‘æŠŠå®ƒä»¬æ”¶é›†èµ·æ¥æ–¹ä¾¿ä½¿ç”¨ã€‚

å…¶ä¸­æ¯ä¸€ä¸ªéƒ½å¯¹åº”ä¸€ä¸ªå•ç‹¬çš„é¡¹ç›®ï¼Œåœ¨æºç ä¸­çš„[config/rebar.config](https://github.com/zhuoyikang/slg-server/blob/master/config/rebar.config)ä¾èµ–æŒ‡å®šã€‚


## 1.2 å‰æ
---

å¦‚æœä½ æƒ³ç»§ç»­å¾€ä¸‹çœ‹ï¼Œè¯·ç¡®ä¿ä½ å¯¹erlangæœ‰äº†ä»¥ä¸‹äº†è§£ï¼š

* åŸºæœ¬æŒæ¡erlangçš„é¡ºåºå¼
* åŸºæœ¬æŒæ¡erlangå¹¶å‘ç¼–ç¨‹
* æŒæ¡OTP(gen_server,gen_supervisorç­‰)ã€‚

æœ‰äº†è¿™äº›åŸºç¡€ï¼Œä½ å¯ä»¥æ— éšœç¢çš„é˜…è¯»æºç ã€‚


# 2 è¿æ¥å¤„ç† slg-proto
---
è¿æ¥å¤„ç†æŒ‡çš„æ˜¯å¤„ç†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„è¿æ¥é€šä¿¡ã€‚

ç”±äºerlangçš„è½»é‡çº§è¿›ç¨‹è®©è¿æ¥å¤„ç†ç¼–å†™èµ·æ¥éå¸¸ç®€å•ï¼Œé¦–å…ˆæœ‰ä¸ªç›‘å¬è¿›ç¨‹ï¼Œå®ƒç›‘å¬æŸä¸ªç«¯å£ï¼Œä¸æ–­çš„å¤„ç†å®¢æˆ·ç«¯æ–°å‘èµ·çš„è¿æ¥ï¼Œæ¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„è¿æ¥éƒ½ä¼šè¢«ç›‘å¬è€…è¿”å›ä¸€ä¸ªæ–°çš„socketï¼Œè¿™æ—¶å€™æ–°å¼€ä¸€ä¸ªè¿›ç¨‹æ¥å¤„ç†è¿™ä¸ªsocketï¼Œå®ƒå¯ä»¥æ¥å—socektæ•°æ®ï¼Œæˆ–è€…é€šè¿‡å®ƒå‘å®¢æˆ·ç«¯å‘é€æ•°æ®ã€‚

## 2.1 ç›‘å¬è¿›ç¨‹
---
ç›‘å¬è¿›ç¨‹æˆ‘åœ¨ä»£ç ä¸­å°†å…¶å‘½åä¸º[conn_acceptor](https://github.com/zhuoyikang/slg-proto/blob/master/src/conn_acceptor.erl)ï¼Œä»£è¡¨è¿æ¥æ¥å—è€…ï¼Œä¸‹é¢ä¸¤å¥ä»£ç å°†åˆ›å»ºä¸€ä¸ªç›‘å¬å¥—æ¥å­—ï¼š

```
%% æ‰§è¡Œç›‘å¬.
listen_port() ->
  Options = [binary, {packet, 0}, {reuseaddr, true},
             {backlog, 1024}, {active, false}],
  gen_tcp:listen(4000, Options).
```
è€Œæ•´ä¸ª`conn_acceptor`è¿›ç¨‹å¤„åœ¨è¿™ä¸ªå¾ªç¯å‡½æ•°é‡Œï¼š

```
%% ç›‘å¬å¾ªç¯.
acceptor_loop(ListenSocket) ->
  case (catch gen_tcp:accept(ListenSocket, 50000)) of
    {ok, Socket} -> handle_connection(Socket);
    {error, Reason} -> handle_error(Reason);
    {'EXIT', Reason} -> handle_error({exit, Reason})
  end,
  acceptor_loop(ListenSocket).
```
è¿™æ ·[conn_acceptor](https://github.com/zhuoyikang/slg-proto/blob/master/src/conn_acceptor.erl)æ¥å—å®Œä¸€ä¸ªè¿æ¥åï¼Œåˆç»§ç»­ç­‰å¾…ä¸‹ä¸€ä¸ªè¿æ¥çš„åˆ°æ¥ï¼Œè€Œgen_tcp:acceptorçš„ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºç­‰å¾…è¶…æ—¶æ—¶é—´ã€‚

è¿™é‡Œæ˜¯å…³[accept](http://erlang.org/doc/man/gen_tcp.html#accept-2)å‡½æ•°çš„æè¿°ã€‚

å†è¿æ¥åˆ°æ¥ä¹‹åï¼Œä½¿ç”¨`handle_connectionå¤„ç†`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
%% æ–°çš„å®¢æˆ·ç«¯è¿æ¥å»ºç«‹.
do_handle_connection(Socket) ->
  case conn_super:start_player(Socket) of
    {ok, PlayerPID} -> gen_tcp:controlling_process(Socket, PlayerPID);
    {error, Reason}->  io:format("error ~p~n", [Reason])
  end.
```
åœ¨ä»£ç ä¸­conn_superä¸ºæ‰€æœ‰è¿æ¥è¿›ç¨‹çš„ç›‘ç£è€…ï¼Œè™½ç„¶è¿æ¥è¿›ç¨‹ä¸éœ€è¦åšé‡å¯ä¹‹ç±»çš„å·¥ä½œï¼Œä½†æ˜¯ä¸ºäº†æ¡†æ¶çš„ä¸€è‡´ï¼Œè¿æ¥å¤„ç†è¿›ç¨‹éƒ½åœ¨conn_superçš„ç›‘ç£ä¹‹ä¸‹ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ä»¥ä¸‹ä»£ç ï¼š
```
gen_tcp:controlling_process(Socket, PlayerPID);
```
è¿™è¡Œä»£ç å°†è¯¥Socketçš„å¤„ç†è¿›ç¨‹è®¾ç½®ä¸ºåˆšåˆšå»ºç«‹èµ·æ¥çš„è¿æ¥å¤„ç†è¿›ç¨‹ï¼Œè¿™æ ·ä»socketä¼ æ¥çš„æ•°æ®å¯ä»¥ç›´æ¥åœ¨è¯¥è¿›ç¨‹çš„handle_infoå‡½æ•°ä¸­å¤„ç†ï¼Œéå¸¸æ–¹ä¾¿ã€‚

## 2.2 è¿æ¥å¤„ç†è¿›ç¨‹
---

è¿™éƒ¨åˆ†çš„ä»£ç ä½äº[conn.erl](https://github.com/zhuoyikang/slg-proto/blob/master/src/conn.erl)ï¼Œå®ƒæ˜¯ä¸€ä¸ªgen_serverï¼Œå€¼å¾—æ³¨æ„çš„å…¶initå‡½æ•°

```
init([Socket]) ->
  process_flag(trap_exit, true),
  inet:setopts(Socket, [{active, once}, {packet, 2}, binary]),
  State = #state{socket = Socket},
  erlang:put(socket, Socket),
  {ok, State}.
```

å…¶ä¸­`inet:setopts(Socket, [{active, once}, {packet, 2}, binary]),`è®¾ç½®äº†ä¸¤ä¸ªé€‰é¡¹ï¼š

### 2.2.1 {active, once}
---

 *{active, once}*ï¼šä¸€èˆ¬æƒ…å†µä¸‹ï¼Œsocketçš„æ•°æ®æ¥æ”¶æ˜¯ç”¨`gen_tcp:recv`å‡½æ•°ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡è¿™ä¸ªå‚æ•°è®¾ç½®ä»¥åï¼Œsocketçš„æ•°æ®å¯ä»¥é€šè¿‡æ¶ˆæ¯æ¥å¤„ç†ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰socketæ•°æ®æ¥çš„æ—¶å€™ï¼Œè¯¥è¿›ç¨‹ä¼šæ”¶åˆ°ä¸€ä¸ª`handle_info({tcp, Socket, Bin}, State)`æ¶ˆæ¯ï¼Œè¿™æ ·å¤„ç†èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚ä½†æ˜¯onceçš„æŒ‡æ˜è¿™æ ·çš„è¡Œä¸ºåªå‘ç”Ÿä¸€æ¬¡ï¼Œä¸‹ä¸€æ¬¡ä½ è¿˜æ˜¯è¦é€šè¿‡`gen_tcp:recv`å‡½æ•°è·å–æ•°æ®ï¼Œæ‰€ä»¥ä¸ºäº†æ–¹ä¾¿ï¼Œ`hanle_info`é‡Œé‡å¤è®¾ç½®äº†è¿™ä¸ªé€‰é¡¹ï¼š
 
 ```
 handle_info({tcp, Socket, Bin}, State) ->
  inet:setopts(Socket, [{active, once}, {packet, 2}, binary]),
  ...
 ```
 ä½ å¯ä»¥è®¾ç½®ä¸º{active, false}ï¼Œè¿™æ ·å°†åªèƒ½ä½¿ç”¨gen_tcp:recvæ¥å—æ¶ˆæ¯ï¼Œæˆ–è€…{active,true}è¡¨ç¤ºæ¯æ¬¡éƒ½é€šè¿‡handle_infoæ¥å—æ¶ˆæ¯ã€‚
 
 è€Œ{active, once}çš„æ„ä¹‰åœ¨äºå¯ä»¥é¿å…è®¾ç½®ä¸º{active, true}æ—¶å¤§é‡çš„socketçš„æ¶ˆæ¯å‘ç”Ÿç»™è¿›ç¨‹ï¼Œé€ æˆè¿›ç¨‹å¤„ç†ä¸äº†å…¶ä»–æ¶ˆæ¯ã€‚
 
### 2.2.2 {packet, 2}
---
è¿™ä¸ªé€‰é¡¹è®¾ç½®å¯¹äºæ¯ä¸ªé€šè¿‡gen_tcp:sendå‘å‡ºçš„æ•°æ®åŒ…ï¼Œerlangéƒ½è‡ªåŠ¨åœ¨å‰é¢åŠ ä¸Šä¸¤ä¸ªå­—èŠ‚ï¼Œè€Œè¿™ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºçš„æ˜¯ä½ è¦å‘é€æ•°æ®åŒ…çš„é•¿åº¦ã€‚

åŒæ—¶ï¼Œå½“erlangåœ¨åº•å±‚ä¸ºsocketç›‘å¬æ•°æ®æ—¶{active, once}ï¼Œä¹Ÿå‡è®¾æ¯ä¸ªåŒ…çš„å‰ä¸¤ä¸ªå­—èŠ‚æ˜¯æ•´ä¸ªåŒ…çš„é•¿åº¦ï¼Œå¦‚æœåŒ…æœªæ¥å—å®Œæ•´ï¼Œerlangä¼šè‡ªåŠ¨å¸®ä½ å¤„ç†ç¼“å­˜ï¼Œç›´åˆ°åŒ…æ•°æ®å®Œå…¨æ¥å—å†å‘é€({tcp, Socket, Bin},æ¶ˆæ¯ï¼Œéå¸¸å¼ºå¤§ã€‚

æ‰€ä»¥å¦‚æœä½ æ˜¯C/C++ç¨‹åºå‘˜ï¼Œå¥—æ¥å­—ç¼“å­˜é€šè¿‡è¿™ä¸ªå‚æ•°çš„è®¾ç½®å°±å®Œå…¨æå®šäº†ï¼Œæˆ‘æƒ³è¿™ä¹Ÿæ˜¯æ¸¸æˆè¡Œä¸šä¸å°‘äººé€‰æ‹©erlangçš„åŸå› ä¹‹ä¸€ã€‚

### 2.2.3 hotwheels
---
æ•´ä¸ªè¿æ¥å¤„ç†éƒ¨åˆ†åŒ…æ‹¬conn_acceptorå’Œconn.erlï¼Œè€Œä»£ç æœ¬çœå…¶å®ä¸æ˜¯æˆ‘å†™çš„ï¼Œæ˜¯æˆ‘å­¦ä¹ erlangçš„æ—¶å€™ä»[hotwheels](https://github.com/tolbrino/hotwheels)é‡Œé¢ç§»æ¤è¿‡æ¥çš„ï¼Œhotwheelsæ˜¯erlang tcpè¿æ¥å¤„ç†çš„å…¸èŒƒã€‚

å¥½äº†ï¼Œè¿™å°±æ˜¯æ•´ä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šä¿¡çš„ä¼ è¾“å±‚ï¼Œä½ å¯ä»¥è‡ªå·±å†™ä¸ªecho-serveræ¥è¯•è¯•ï¼Œè¾¾åˆ°å®Œå…¨æŒæ¡çš„ç¨‹åº¦ã€‚

C/C++ç¨‹åºå‘˜å¯èƒ½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆæ²¡æœ‰epollç­‰ioå¤šè·¯å¤ç”¨å¤„ç†ï¼Œå…¶å®å‘¢erlangè™šæ‹Ÿæœºå·²ç»å¸®ä½ å¤„ç†äº†ï¼Œä½ åªéœ€è¦éšä¾¿å¼€ä¸€ä¸ªè¿›ç¨‹æ¥å¤„ç†ä¸€ä¸ªè¿æ¥ï¼Œå› ä¸ºåœ¨erlangä¸­ï¼Œè¿›ç¨‹æœ¬èº«å’Œè¿›ç¨‹åˆ‡æ¢éƒ½éå¸¸å»‰ä»·ã€‚

## 2.3 æ•°æ®åºåˆ—åŒ–å’Œåè®®è®¾è®¡
---

### 2.3.1 æ–‡æœ¬åè®® VS äºŒè¿›åˆ¶åè®®
---
åœ¨æ¸¸æˆæœåŠ¡å™¨è®¾è®¡ä¹‹åˆï¼Œæˆ‘æ›¾ç»çº ç»“è¿‡æ˜¯å¦ä½¿ç”¨æ–‡æœ¬åè®®ï¼Œè€Œå¯¹äºæ¸¸æˆæœåŠ¡å™¨æ¥è¯´ï¼Œä½¿ç”¨æ–‡æœ¬åè®®æ¯”å¦‚Jsonæˆ–è€…Xmlæœ‰ä»¥ä¸‹åå¤„ï¼š

1. å ç”¨æ›´å¤§çš„æµé‡ï¼šå¦‚æœä½ æ˜¯æ‰‹æ¸¸ï¼Œä½¿ç”¨Jsonæˆ–è€…Xmlåè®®å¸¦æ¥çš„æµé‡å°†ä¼šæ˜¯äºŒè¿›åˆ¶åè®®çš„å¥½å‡ å€,è€Œæ¯ä¸ªæ‰‹æœºç”¨æˆ·çš„æµé‡éƒ½æ˜¯æœ‰é™çš„ï¼Œå¦‚æœèƒ½çœä¸‹æ¥å°†ä¼šæ˜¯ä¸€ä¸ªæ¸¸æˆç›¸æ¯”ç«äº‰å¯¹æ‰‹çš„ä¼˜åŠ¿ã€‚
2. erlangå¤„ç†å­—ç¬¦ä¸²å¾ˆç³Ÿç³•ï¼šè¿™ä¸ªå­¦è¿‡erlangçš„åº”è¯¥éƒ½çŸ¥é“ï¼Œerlangçš„å­—ç¬¦ä¸²æ˜¯é“¾è¡¨ï¼Œä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹è‡³å°‘è€—8ä¸ªå­—èŠ‚ï¼Œæ›´è€—å†…å­˜ï¼Œç„¶è€Œerlangå¤„ç†äºŒè¿›åˆ¶éå¸¸ä¼˜ç§€ï¼Œæ‰€ä»¥äºŒè¿›åˆ¶æ˜¯æ›´é€‚åˆerlangçš„é€‰æ‹©ã€‚

### 2.3.2 äºŒè¿›åˆ¶åè®®
---
å¦‚ä½•è®¾è®¡åè®®ï¼Œè¿™æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œå¯ä»¥æ€è€ƒä¸€ä¸‹ï¼šé¦–å…ˆè¦æœ‰åŒ…ç±»å‹ï¼Œè¿™ä¸ªéå¸¸å®¹æ˜“ç†è§£ï¼Œæ¯”å¦‚ç™»é™†è¯·æ±‚åŒ…ï¼Œå»ºç­‘å‡çº§åŒ…ï¼Œå……å€¼è¯·æ±‚åŒ…ç­‰ä¸åŒçš„åŒ…ç”¨æ¥å®Œæˆä¸åŒçš„é€»è¾‘åŠŸèƒ½ï¼Œè€ŒåŒºåˆ†ä¸åŒçš„åŒ…ç±»å‹åªè¦ä¸€ä¸ªæ•°å­—å°±è¡Œäº†ï¼Œåªè¦å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çº¦å®šå¥½ä¸åŒæ•°å­—å¯¹åº”çš„åŒ…ç±»å‹æ˜¯ä»€ä¹ˆã€‚

å…¶æ¬¡è¦è®¾è®¡åŒ…å†…å®¹ï¼Œå› ä¸ºç™»é™†è¯·æ±‚åŒ…å‘é€çš„æ˜¯ç”¨æˆ·åå’Œå¯†ç ï¼Œå»ºç­‘å‡çº§åŒ…å‘é€çš„å»ºç­‘ç›¸å…³ä¿¡æ¯ï¼Œä¸åŒçš„åŒ…çš„å†…å®¹æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ˜¯éœ€è¦æ ¹æ®æ¸¸æˆé€»è¾‘æ¥è®¾è®¡çš„ï¼Œæ‰€ä»¥åè®®è®¾è®¡é›†ä¸­åœ¨*åŒ…ç±»å‹*å’Œ*åŒ…å†…å®¹*å¤„ç†ã€‚

åŠ ä¸Šä¹‹å‰çš„ä¸¤ä¸ªå­—èŠ‚çš„{packet, 2}ï¼Œä¸€ä¸ªå®Œæ•´çš„åŒ…åº”è¯¥æ˜¯ä¸‹å›¾æ‰€ç¤ºçš„äºŒè¿›åˆ¶åºåˆ—ï¼š

	--------------------------------------
	|åŒ…å¤´(2å­—èŠ‚)|åŒ…ç±»å‹(2å­—èŠ‚)|åŒ…å†…å®¹(å‰©ä½™å­—èŠ‚)|
	--------------------------------------

æ¯ä¸€ä¸ªtcpè¿æ¥éƒ½åº”è¯¥å…ˆæ”¶å–2ä¸ªå­—èŠ‚ï¼Œè·å¾—å…¶ååŒ…ç±»å‹å’Œå’ŒåŒ…å†…å®¹çš„å®Œæ•´æ•°æ®ã€‚ç„¶åå–å®Œæ•´æ•°æ®çš„å‰2ä¸ªå­—èŠ‚ä¸ºåŒ…ç±»å‹ï¼Œè¿™ä¸ªåŒ…ç±»å‹å†³å®šäº†åŒ…å†…å®¹çš„æ‰€æè¿°çš„æ•°æ®ç»“æ„ã€‚æ‰€ä»¥åŒ…å¤´å’ŒåŒ…ç±»å‹éƒ½å¾ˆç®€å•ç¼–ç¨‹ï¼Œå¤æ‚çš„æ˜¯åŒ…å†…å®¹ã€‚

### 2.3.2 æ•´å‹åºåˆ—åŒ–
---
åŒ…å†…å®¹å°±æ˜¯ç”¨äº†äºŒè¿›åˆ¶åºåˆ—åŒ–é€»è¾‘æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚google protobuffå°±æ˜¯å¹²è¿™æ ·çš„äº‹æƒ…ï¼Œä¸è¿‡æˆ‘ä¸æ‰“ç®—ç”¨ï¼Œå› ä¸ºå®ƒå¤ªå¼ºå¤§å¤ªå¤æ‚ï¼Œç»å¤§å¤šæ•°çš„åŠŸèƒ½ç”¨ä¸ä¸Šï¼Œè€Œä¸”å¯¹erlangä¹Ÿä¸æ˜¯å®˜æ–¹æ”¯æŒã€‚

å…ˆä¸è¦æƒ³çš„å¤ªå¤æ‚ï¼Œä½ å¯ä»¥è€ƒè™‘ä»¥ä¸‹å¦‚æœä½¿ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºä¸€ä¸ªæœ€ç®€å•çš„æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚å¦‚ä½•è¡¨ç¤ºä¸€ä¸ªbooleanå€¼ï¼Œéå¸¸ç®€å•ï¼Œ0è¡¨ç¤ºfalseï¼Œ 1è¡¨ç¤ºtrueï¼Œæ‰€ä»¥åªéœ€è¦ä¸€ä¸ªå­—èŠ‚å³å¯ï¼Œé‚£ä¹ˆåŒ…å«äº†ä¸€ä¸ªbooleanç±»å‹æ•°æ®çš„å®Œæ•´çš„åŒ…å°±æ˜¯è¿™æ ·ï¼š
```
--------------------------------------
|åŒ…å¤´(2å­—èŠ‚)|åŒ…ç±»å‹(2å­—èŠ‚)|1å­—èŠ‚(0æˆ–1)|
--------------------------------------
```
ç°åœ¨è®¾ç±»å‹1çš„åŒ…å†…å®¹å°±æ˜¯ä¸€ä¸ªç®€å•çš„booleanç±»å‹ï¼Œé‚£ä¹ˆå½“è¯»å‡ºåŒ…ç±»å‹ä¸º1çš„æ—¶å€™ï¼Œæœ€åè‚¯å®šåªå‰©ä¸‹1ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬æŠŠå®ƒè½¬æˆcharå³å¯ï¼Œå¾ˆç®€å•ã€‚

å¯ä»¥çœ‹å‡ºï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“booleanç±»å‹çš„é•¿åº¦ï¼Œå¯ä»¥ç›´æ¥åœ¨åŒ…å†…å®¹ä¸­å–1ä¸ªå­—èŠ‚å³å¯ã€‚

é‚£ä¹ˆä¹Ÿå¯ä»¥è®¾è®¡ä¸€ä¸ªint32ç±»å‹çš„æ•°æ®ç±»å‹ï¼Œå®ƒå°±æ˜¯å ç”¨4ä¸ªå­—èŠ‚è€Œå·²ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹erlangä»£ç ç›´æ¥å°†ä¸€ä¸ªæ•°å­—è½¬æ¢ä¸ºä¸€ä¸ª32ä½çš„äºŒè¿›åˆ¶è¡¨ç¤º(è¡¥ç è¡¨ç¤º)ï¼š

```
encode_integer(Int) when is_integer(Int) ->
  <<Int:32>>.
```
ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç å°†äºŒè¿›åˆ¶è½¬æ¢ä¸ºintæ•°å­—:

```
decode_integer(<<Integer:32/signed, Data/binary>>)  ->
  {Integer, Data}.
```

ä½¿ç”¨erlangå¹²è¿™ä¸ªäº‹æƒ…å¤ªç®€å•äº†ï¼ï¼ï¼ï¼Œå¯ä»¥ä¸€å£æ°”æŠŠå¸¸ç”¨æ•´å½¢çš„åºåˆ—åŒ–çš„å…¨éƒ¨å†™å‡ºæ¥ï¼š

```
encode_integer(Int) -> <<Int:32>>.
decode_integer(<<Integer:32/signed-big-integer, Data/binary>>)  ->
  {Integer, Data}.
  
%% è§£æshort
encode_short(Short) -> <<Short:16/signed-big-integer>>.
decode_short(<<Short:16/signed-big-integer, Data/binary>>)  ->
  {Short, Data}.
...
```

è¿™éƒ¨åˆ†ä»£ç æˆ‘åœ¨[slg_proto](https://github.com/zhuoyikang/slg-proto/blob/master/src/proto_payload.erl)é‡Œé¢å®ç°äº†ã€‚

### 2.3.3 å­—ç¬¦ä¸²åºåˆ—åŒ–
---
æ•´å½¢æ˜¯å®šé•¿ç±»å‹ï¼Œæ‰€ä»¥æ¯”è¾ƒå¥½å¤„ç†ï¼Œé‚£ä¹ˆå­—ç¬¦ä¸²è¿™æ ·çš„å˜é•¿ç±»å‹æ€ä¹ˆå¤„ç†ï¼Œäº‹å…ˆæ˜¯ä¸å¯èƒ½çŸ¥é“ä¸€ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦çš„ï¼Œæ‰€ä»¥åºåˆ—åŒ–è¿‡ç¨‹éœ€è¦åŒ…å«å…¶é•¿åº¦ï¼Œå¯¹äºå­—ç¬¦ä¸²ç±»å‹çš„åºåˆ—åŒ–ï¼Œè®¾è®¡å‰ä¸¤ä¸ªå­—èŠ‚ä¸ºæ•´ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„é•¿åº¦ï¼Œç„¶åå­—ç¬¦ä¸²å†…å®¹ç´§è·Ÿå…¶åï¼š

```
-----------------------------------
|å­—ç¬¦ä¸²é•¿åº¦(2å­—èŠ‚)|å­—ç¬¦ä¸²å†…å®¹(å‰©ä½™å­—èŠ‚)|
-----------------------------------
```
æ‰€ä»¥å¯ä»¥å†™å‡ºå­—ç¬¦ä¸²ç±»å‹çš„åºåˆ—åŒ–å‡½æ•°ï¼š

```
%% è§£æstring
encode_string(String) when is_list(String) ->
  StringLen = length(String),
  %% BinS = unicode:characters_to_binary(String),
  %%L = byte_size(BinS),
  list_to_binary([<<StringLen:16>>, String]).  
decode_string(<<Length:16/unsigned-big-integer,Data/binary>>)  ->
  {StringData, StringLeftData} = split_binary(Data,Length),
  String = StringData, %%, binary_to_list(StringData),
  {String, StringLeftData}.
```
æ³¨æ„ï¼Œè¿™é‡Œçš„å­—ç¬¦ä¸²åºåˆ—åŒ–å…¶å®å¯¹erlangè€Œè¨€æ˜¯binaryç±»å‹çš„åºåˆ—åŒ–ï¼Œå› ä¸ºåœ¨erlangä»£ç ä¸­æˆ‘ä»¬å°†å¯¹å­—ç¬¦ä¸²ä½¿ç”¨binaryç±»å‹è€Œélistï¼Œä½¿ç”¨<<"name">>è€Œé"name"ã€‚

### 2.3.4 ç±»å‹åµŒå¥—
---
é‚£ä¹ˆï¼Œå¦‚æœåºåˆ—åŒ–ä¸€ä¸ªç©å®¶çš„ç™»é™†ä¿¡æ¯ï¼ŒåŒ…æ‹¬(è´¦å·ï¼Œå¯†ç å’Œæ€§åˆ«)ä¸‰ä¸ªå­—æ®µï¼Œä»åŒ…å†…å®¹æ¥çœ‹ï¼Œåˆ†åˆ«æ˜¯ å­—ç¬¦ä¸²ç±»å‹|å­—ç¬¦ä¸²ç±»å‹|charç±»å‹ï¼š

```
----------------------------------------------------------------
|è´¦å·å­—ç¬¦ä¸²é•¿åº¦(2å­—èŠ‚)|è´¦å·å­—ç¬¦ä¸²å†…å®¹|å¯†ç é•¿åº¦(2å­—èŠ‚)|å¯†ç å†…å®¹|æ€§åˆ«(1å­—èŠ‚)|
----------------------------------------------------------------
```

æ‰€ä»¥å¦‚æœè¦å¯¹è¿™ä¸ªç™»é™†æ•°æ®è¿›è¡Œåºåˆ—åŒ–ï¼Œä»£ç åº”è¯¥å¦‚ä¸‹ï¼š

```
å‡è®¾ç™»é™†ç±»å‹ä¸ºrecord(login, {name,password,sex}
encode_login(Login) ->
	NameBin = encode_string(Login#login.name),
	PasswordBin = encode_string(Login#login.password),
	SexBin = encode_string(Login#login.sex),
	list_to_binary([NameBin, PasswordBin, SexBin]).
decode_login(<<Data/binary>>) ->
	{Name, NameLeft} = decode_string(Data),
	{Password, PassLeft} = decode_string(NameLeft),
	{Sex, SexLeft} = decode_char(PassLeft),
	Login = #login{name=Name, password=Password, sex=Sex},
	{Login, SexLeft}
```

`decode_`å‡½æ•°åŒæ—¶ä¹Ÿè¿”å›äº†å‰©ä½™çš„åŒ…å†…å®¹ç»™åç»­å¤„ç†ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„loginç±»å‹å¤„ç†ï¼Œå®ƒä½¿ç”¨èµ·æ¥å’ŒåŸºç¡€ç±»å‹ä¸€æ ·ï¼Œä½†å®ƒæ˜¯ç”±åŸºç¡€ç±»å‹ç»„åˆè€Œæˆçš„ã€‚

åŒæ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªç»„åˆç±»å‹loginæ¥ç»„åˆæˆæ›´å¤æ‚çš„ç±»å‹ï¼Œè¿™å°±æ˜¯`ç±»å‹åµŒå¥—`ã€‚

æœ‰äº†åŸºç¡€æ•°å­—å’Œå­—ç¬¦ä¸²ç±»å‹+ç±»å‹åµŒå¥—ï¼Œå·²ç»å¯ä»¥ç»„åˆå‡ºéå¸¸å¤æ‚çš„ç±»å‹äº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªå¿…é¡»çš„å¤„ç†ï¼Œé‚£å°±æ˜¯`æ•°ç»„`ã€‚

### 2.3.5 æ•°ç»„åºåˆ—åŒ–
---

æ•°ç»„çš„è¡¨ç¤ºæ˜¯æ¸¸æˆé‡Œä¸å¯ç¼ºå°‘çš„ï¼Œä¸€ä¸ªç©å®¶å¯èƒ½æœ‰å¤šä¸ªå»ºç­‘ï¼Œéœ€è¦ç”¨æ•°ç»„è¡¨ç¤ºï¼›æœ‰å¤šä¸ªå¥½å‹ï¼Œä¹Ÿç”¨æ•°ç»„è¡¨ç¤ºï¼Œç­‰ç­‰ï¼Œé‚£å¦‚ä½•åºåˆ—åŒ–ä¸€ä¸ªæ•°ç»„å‘¢ï¼Ÿ

```
---------------------------
|æ•°ç»„å…ƒç´ ä¸ªæ•°(2å­—èŠ‚)| æ•°ç»„å†…å®¹|
--------------------------
```

ä½ å¯ä»¥è¿™æ ·æƒ³ï¼ŒçŸ¥é“äº†æ•°ç»„çš„å…ƒç´ çš„ä¸ªæ•°nå’Œæ•°ç»„çš„ç±»å‹ï¼Œå°±å¯ä»¥è°ƒç”¨*encode_ç±»å‹*æˆ–è€…*decode_ç±»å‹*næ¬¡æ¥å®Œæˆæ•°ç»„ç±»å‹çš„åºåˆ—åŒ–ï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨ä»¥ä¸‹ä»£ç æ¥åºåˆ—åŒ–æ•°ç»„ï¼š

```
%% è§£ææ•°ç»„ç¼–ç 
encode_array_item([],_Fun) ->
  [];
encode_array_item([H|T],Fun) ->
  [proto_payload:Fun(H) | encode_array_item(T,Fun)].
encode_array(Array,Fun) when is_list(Array) ->
  List = encode_array_item(Array,Fun),
  ListData = list_to_binary(List),
  ListLen = length(List),
  list_to_binary([<<ListLen:16/unsigned-big-integer>>, ListData]).
decode_array_item(0, <<Data/binary>>, _Fun) ->
  [Data];
decode_array_item(N, <<Data/binary>>, Fun) ->
  {Item, ItemDataLeft} = proto_payload:Fun(Data),
  [Item | decode_array_item(N-1, ItemDataLeft, Fun)].
decode_array(<<ArrayLen:16/unsigned-big-integer, Data/binary>>, Fun) ->
  ArrayItem = decode_array_item(ArrayLen, Data, Fun),
  Length = length(ArrayItem),
  {Array, [ArrayDataLeft]} = lists:split(Length-1, ArrayItem),
  {Array, ArrayDataLeft}.
```
æ•°ç»„å…ƒç´ çš„åºåˆ—åŒ–å°†æˆä¸ºç¬¬3ä¸ªå‚æ•°Funï¼Œè¿™æ ·å°±å¯ä»¥ç”¨è¿™æ®µä»£ç æ¥å¤„ç†ä¸åŒçš„æ•°ç»„ç±»å‹äº†ã€‚

æ‰€ä»¥åºåˆ—åŒ–ä¸€ä¸ªå«æœ‰3ä¸ªintegerç±»å‹çš„æ•°ç»„è°ƒç”¨å¦‚ä¸‹ï¼š

```
encode_array([2,3], encode_integer) -> â€¦
decode_array(Binary, encode_integer) -> â€¦ 
```

### 2.3.6 åè®®è®¾è®¡
---

æ€»ç»“ä¸€ä¸‹ä¸Šæ–‡ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½é€šè¿‡åŒ…ç±»å‹æ¥å†³å®šå¦‚ä½•åºåˆ—åŒ–æ•°æ®å’ŒåŒ…å†…å®¹ï¼›å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½çŸ¥é“åŒ…å†…å®¹æ˜¯ç”±ä»€ä¹ˆæ•°æ®ç»„æˆçš„ï¼Œä»¥åŠå®ƒä»¬çš„ç±»å‹ã€‚ç„¶è€Œå£å¤´ä¸Šçš„çº¦å®šä¸è¶³ä»¥ä¿è¯ç¨‹åºçš„æ­£ç¡®å’Œå¥å£®ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦ä¸€ä¸ªä¸­é—´æ–‡ä»¶æ¥å¯¹åŒ…ç±»å‹å’ŒåŒ…å†…å®¹è¿›è¡Œç»Ÿä¸€çš„æè¿°ã€‚

#### 2.3.6.1 åŒ…ç±»å‹api.txt

åœ¨slg_protoçš„[proto/api.txt](https://github.com/zhuoyikang/slg-proto/blob/master/proto/api.txt)é‡Œé¢åˆ—å‡ºäº†æ¸¸æˆæœåŠ¡å™¨ä¸­çš„æ‰€æœ‰çš„åŒ…ç±»å‹ï¼š

```
packet_type:10001
name:code_ack
payload:pt_code
desc:å¾…ç”¨åŠ å¯†key.

packet_type:1
name:login_req
payload:pt_account
desc:å¾…ç”¨åŠ å¯†key.
module:conn_test
```

å®ƒä»¬æ¯ä¸€ä¸ªéƒ½åŒ…å«ä»¥ä¸‹å±æ€§ï¼š

* packet_type: åŒ…ç±»å‹IDï¼Œæ˜¯ä¸ªå”¯ä¸€çš„æ•°å­—ï¼Œ10000å·ä»¥ä¸Šç”¨ä½œåŠŸèƒ½ï¼Œ10000ä»¥ä¸‹ç”¨ä½œé€»è¾‘ä½¿ç”¨ã€‚
* name:åŒ…åå­—ï¼Œç¨‹åºä¸­æˆ‘å¸Œæœ›ç›´æ¥ä½¿ç”¨åå­—æ¥æ“ä½œåŒ…ï¼Œè€Œä¸æ˜¯æ•°å­—ï¼Œè¿™æ ·æ›´å‹å¥½ã€‚
* payload:åŒ…å†…å®¹çš„ç±»å‹ï¼Œå°†åœ¨ä¸‹é¢æè¿°ã€‚
* desc:ä¸€æ®µé—´æ–­çš„æ³¨é‡Šï¼Œæè¿°å®ƒçš„ä½œç”¨ã€‚
* module:ç›´æ¥æŒ‡æ˜åŒ…çš„å¤„ç†æ¨¡å—ï¼Œå®ƒå°†ä¼šå»è¯¥æ¨¡å—å¯»æ‰¾å…¶ä¸nameåŒåçš„å‡½æ•°è°ƒç”¨å¤„ç†è¯¥åŒ…ã€‚

#### 2.3.6.2 åŒ…å†…å®¹api.txt

åœ¨slg_protoçš„[proto/protocal.txt](https://github.com/zhuoyikang/slg-proto/blob/master/proto/protocal.txt)é‡Œé¢åˆ—å‡ºæ‰€æœ‰çš„åŒ…å†…å®¹ç±»å‹ï¼š

    # æ™®é€šé”™è¯¯å›å¤
	pt_code=
	api integer
	code integer
	===

	# ç©å®¶åŸºæœ¬ä¿¡æ¯
	# name åå­—
	# sex æ€§åˆ«
	pt_ubase=
	name string
	sex string
	===
	
	# ç©å®¶å»ºç­‘ä¿¡æ¯
	db_building=
	id pkid
	user_id pkid
	b_type string
	sort integer
	level integer
	===
	
	# å»ºç­‘ç±»å‹åˆ—è¡¨
	db_buildings=
	buildings db_building $array
	===
	
å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å°†é€šè¿‡è¿™ä¸¤ä¸ªæ–‡ä»¶çº¦å®šåè®®ï¼Œå¹¶å„è‡ªç¼–å†™ç¨‹åºç”Ÿæˆå…¶åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä»£ç ã€‚

æœ‰ä»¥ä¸‹åŸºç¡€ç±»å‹ï¼š

integer, uinteger, short, ushort, char, uchar, boolean, string, pkidã€‚

pkidæ˜¯ä¸“é—¨ä¸ºä¸»é”®è®¾è®¡çš„æ•°æ®ç±»å‹ï¼Œå®ƒå…¶å®æ˜¯è¢«åºåˆ—åŒ–ä¸ºstringç±»å‹ã€‚

#### 2.3.6.2 ä»£ç ç”Ÿæˆ

çŸ¥é“äº†å†…å®¹ç±»å‹ååºåˆ—åŒ–å’Œååºåˆ—åŒ–ä»£ç å°±å˜æˆäº†å•ç‹¬æ— èŠçš„å·¥ä½œï¼Œæ‰€ä»¥æˆ‘å†™äº†ä¸ªrubyç¨‹åºæ¥é€šè¿‡åè®®æ–‡ä»¶ç”Ÿæˆè¿™éƒ¨åˆ†ä»£ç ï¼š[proto_gen2.rb](https://github.com/zhuoyikang/slg-proto/blob/master/src/proto_gen2.rb)ã€‚

æœ‰äº†ä»£ç ç”Ÿæˆå™¨ï¼Œæ¯æ¬¡ä¿®æ”¹äº†åè®®å†…å®¹ï¼Œåªéœ€è¦åœ¨é¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œmake gå³å¯é‡æ–°ç”Ÿæˆä»£ç ï¼Œç”Ÿæˆçš„ä»£ç è·¯å¾„ä¸ºï¼šproto/code/

* proto_api.erl: APIåå­—å’ŒIDçš„æ˜ å°„å‡½æ•°ã€‚
* proto_decoder.erl: APIçš„è§£åŒ…å‡½æ•°ã€‚
* proto_encoder.erl: APIçš„æ‰“åŒ…å‡½æ•°ã€‚
* proto_error.erl:é”™è¯¯ç æ˜ å°„å‡½æ•°ã€‚
* proto_indian.hrl: åŒ…å†…å®¹æ‰“åŒ…å’Œè§£åŒ…å‡½æ•°ã€‚
* proto_record.hrl: å°†protocal.txtçš„æ•°æ®ç»“æ„è½¬ä¸ºrecordã€‚
* proto_route.erl: æ¯ä¸€ä¸ªåå­—reqç»“å°¾çš„åŒ…ç±»å‹éƒ½ä¼šåœ¨å…¶ä¸­æ‰¾åˆ°å…¶å¤„ç†å‡½æ•°ã€‚

è¿™å°±æ˜¯åè®®ç”Ÿæˆçš„è¯¦ç»†å†…å®¹ï¼Œå¦‚æœä½ å®Œå…¨ç†è§£äº†è¿™éƒ¨åˆ†ï¼Œåè®®å¤„ç†å°±æå®šäº†ã€‚

### 2.3.7 åŠ å¯†è§£å¯†
---

æ¯ä¸ªå…¬å¸æˆ–è€…é¡¹ç›®æœ‰è‡ªå·±å¯¹åŠ å¯†å’Œè§£å¯†æ–¹é¢çš„è¦æ±‚ï¼Œè¿™é‡Œå°±ä¸æ¶‰åŠäº†ï¼Œåªéœ€åœ¨åœ¨æ‰“åŒ…ä¹‹ååŠ å¯†ï¼Œè§£åŒ…ä¹‹å‰è§£å¯†å³å¯ã€‚

## 2.4 è¿æ¥è¿›ç¨‹
---
å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥ä¸ŠæœåŠ¡å™¨åï¼Œå®ƒæ‰€æœ‰çš„ä»£ç éƒ½åœ¨è¿™ä¸ªè¿æ¥è¿›ç¨‹ä¸­æ‰§è¡Œï¼ŒåŒ…æ‹¬æ¶ˆæ¯å¤„ç†ï¼Œhandle_infoï¼Œhandle_cast, handle_calï¼Œä½†æ˜¯æˆ‘å¹¶ä¸å¸Œæœ›åœ¨æ·»åŠ æ–°çš„é€»è¾‘çš„æ—¶å€™è¿˜éœ€è¦æ”¹åŠ¨conn.erlæºç ï¼Œæ‰€ä»¥æˆ‘åŠ å…¥äº†ä¸€ä¸ªapiè®©ä½ å¯ä»¥æ’å…¥è‡ªå·±çš„æ¶ˆæ¯å¤„ç†æ¨¡å—ï¼š

```
%% æŒ‡å®šplayer.erlæ¨¡å—å¤„ç†conn.erlæ¨¡å—çš„å„ç§æ¶ˆæ¯.
conn_config:callback(player) 
%% éœ€è¦å®ç°ä»¥ä¸‹å›è°ƒå‡½æ•°: 
join(_UID) ->
  ok.

quit(_Reason, _State) ->
  ok.

cast(C, State) ->
  State.

info(C, State) ->
  State.

call(C, From, State) ->
  State.
```
å¯ä»¥é€šè¿‡é˜…è¯»conn.erlæºç æŸ¥çœ‹å…¶è°ƒç”¨ç‚¹ã€‚


# 3 æ•°æ®å¤„ç† slg-model
---

[slg-model](https://github.com/zhuoyikang/slg-model)æ˜¯æˆ‘é¡¹ç›®é‡Œå¤„ç†ç©å®¶æ•°æ®çš„å…¨éƒ¨å†…å®¹ã€‚

ä¸€ä¸ªæœåŠ¡æœ€é‡è¦çš„å°±æ˜¯æ•°æ®ï¼Œè¿™é‡Œæˆ‘é‡‡ç”¨MySqlåšç©å®¶æ•°æ®æŒä¹…åŒ–ï¼Œå…ˆè®¨è®ºä¸€ä¸‹é—®é¢˜ï¼š

1.æ¸¸æˆæœåŠ¡å™¨ä¸€èˆ¬å°†æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œåœ¨ç©å®¶ç™»å½•æ—¶å°†å…¶æ•°æ®åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶åœ¨å†…å­˜ä¸­è¿›è¡Œå„ç§é€»è¾‘æ“ä½œï¼Œç„¶åå®šæ—¶çš„å°†å…¶æ•°æ®å†™å›åˆ°æ•°æ®åº“æŒä¹…åŒ–ã€‚

2.æ¸¸æˆæœåŠ¡å™¨æœ‰è¿™æ ·ä¸€ä¸ªæ€§è´¨ï¼Œæ¯”å¦‚ä½ æœ‰400Wç”¨æˆ·ï¼Œå¯èƒ½åªæœ‰å‡ åWæ˜¯æ´»è·ƒçš„ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœæŠŠå…¨éƒ¨çš„ç©å®¶æ•°æ®æ”¾åˆ°å†…å­˜ä¸­å°±æ˜¯å¯¹å†…å­˜æå¤§çš„æµªè´¹ï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸€ä¸ªæœºåˆ¶æ¥æ¸…é™¤æ‰ä¸æ´»è·ƒçš„ç©å®¶æ•°æ®ã€‚


æ‰€ä»¥è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦ç”¨erlangå®ç°ä¸€ä¸ªå¯¹ç©å®¶æ•°æ®çš„å†…å­˜ç¼“å­˜æœºåˆ¶ï¼Œæˆ‘ä½¿ç”¨etsè¡¨å¤„ç†ã€‚

## 3.1 ets vs è¿›ç¨‹å­—å…¸
---

è¿›ç¨‹å­—å…¸å’Œetséƒ½æ˜¯erlangçš„æ•°æ®å­˜å‚¨æœºåˆ¶ï¼Œæœ€åˆçš„æ—¶å€™æˆ‘ä½¿ç”¨äº†è¿›ç¨‹å­—å…¸å­˜å‚¨ç©å®¶æ•°æ®ï¼Œå³åœ¨ç©å®¶ç™»é™†æ—¶å°†å…¶æ•°æ®åŠ è½½åˆ°è¿›ç¨‹å­—å…¸ï¼Œç©å®¶ç™»å‡ºä¹‹åå°†è¿›ç¨‹å­—å…¸é‡Œçš„æ•°æ®ä¼šå†™åˆ°mysqlï¼Œè¿™æ ·ä¼šæœ‰ä»¥ä¸‹é—®é¢˜ï¼š

* åŸºæœ¬æ— æ³•ç¼–å†™å•å…ƒæµ‹è¯•ï¼šè¿›ç¨‹å­—å…¸æ˜¯ä¸€ç§å‰¯ä½œç”¨éå¸¸å¤§çš„å­˜å‚¨æœºåˆ¶ï¼Œå®ƒç ´åäº†å‡½æ•°å¼ç¼–ç¨‹çš„ç¼–ç¨‹æ€æƒ³ï¼Œæœ¬æ¥å‡½æ•°å¼æ˜¯æœ€å¥½å†™å•å…ƒæµ‹è¯•ï¼Œä½†æ˜¯ç°åœ¨ä½ ä¸å¾—ä¸ä¸ºäº†åšå•å…ƒæµ‹è¯•å¼€ä¸€ä¸ªè¿›ç¨‹ï¼Œå¹¶ä¸”å¿…é¡»å‡å®šä½ çš„ä»£ç æ˜¯æ‰§è¡Œåœ¨ç©å®¶è¿›ç¨‹é‡Œã€‚
* å¿…é¡»ä½¿ç”¨é˜²å¾¡å¼ç¼–ç¨‹ï¼šerlangæ˜¯ä¸€é—¨ä¸æ¨èä½ ä½¿ç”¨é˜²å¾¡å¼ç¼–ç¨‹çš„è¯­è¨€ï¼Œå› ä¸ºerlangçš„è¿›ç¨‹çš„å´©æºƒä¸ä¼šé€ æˆæ•´ä¸ªç³»ç»Ÿçš„å´©æºƒï¼Œè¿™æ—¶å€™å¦‚æœæ“ä½œé€»è¾‘ä¸Šæœ‰é”™è¯¯ï¼Œä½†æ˜¯é”™è¯¯æ˜¯ç”±bugæˆ–è€…ä¸åˆç†çš„è¾“å…¥æ“ä½œçš„ï¼Œå´©æºƒå³å¯ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨è¿›ç¨‹å­—å…¸ç®¡ç†ç©å®¶æ•°æ®ï¼Œå¦‚æœè¿›ç¨‹å´©æºƒè¿›ç¨‹å­—å…¸æ•°æ®ä¼šä¸¢å¤±ï¼Œæ‰€ä»¥ä½ ä¸å¾—ä¸ä½¿ç”¨é˜²å¾¡å¼ç¼–ç¨‹ï¼Œé€ æˆç¼–å†™å¤§é‡ä¸‘é™‹çš„ä»£ç ã€‚
* å¦‚æœä½ è¿˜æ˜¯è¦ç”¨è¿›ç¨‹å­—å…¸ï¼Œåº”è¯¥ç”¨å®ƒå­˜æ”¾ä¸€äº›ä¸´æ—¶æ•°æ®ï¼Œé‚£ç§ä¸¢å¤±äº†ä¹Ÿæ— æ‰€è°“çš„æ•°æ®ã€‚

é€‰æ‹©etsæ˜¯å› ä¸ºetsæ˜¯erlangåŸç”Ÿæä¾›çš„å†…å­˜è¡¨ï¼Œè¿™é‡Œç”¨æ¥åšç©å®¶æ•°æ®è¡¨éå¸¸åˆé€‚ã€‚

*ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ mnedia?*

mnesiaæ˜¯erlangæä¾›çš„åˆ†å¸ƒå¼æ•°æ®åº“ï¼ŒåŠŸèƒ½æ¯”è¾ƒå¼ºå¤§ï¼Œä½†å®ƒçš„åŠŸèƒ½å¯¹äºæˆ‘è®¾è®¡æ¸¸æˆæœåŠ¡å™¨å¹¶ä¸æ˜¯æœ‰ç”¨ï¼Œæš‚æ—¶æ²¡æœ‰éœ€è¦ä½¿ç”¨mnesiaçš„ç†ç”±ï¼Œå¦‚æœè®¾è®¡å•æœçš„æ¸¸æˆæœåŠ¡å™¨ï¼Œå¹¶ä¸”è¦é˜²æ­¢å•ç‚¹æ•…éšœï¼Œé‚£ä¹ˆå¯èƒ½ç”¨mnesiaæ¯”è¾ƒåˆé€‚ã€‚

*ä¸ºä»€ä¹ˆè¦æŒ‰æ¨¡å—è¡¨ç»„ç»‡ç©å®¶æ•°æ®?*

æœ‰å¾ˆå¤šæ¸¸æˆéƒ½åªåœ¨mysqlé‡Œé¢å­˜å‚¨ä¸€ä¸ªå®Œæ•´çš„äºŒè¿›åˆ¶ç¨‹åºé•œåƒï¼Œå³åªæœ‰ä¸€å¼ è¡¨ï¼Œä¸¤ä¸ªå­—æ®µ(ç©å®¶idï¼Œç©å®¶æ•°æ®)ï¼Œè¿™æ ·ç¼–ç¨‹æ˜¯éå¸¸ç®€å•æ–¹ä¾¿ï¼Œä½†æ˜¯æœ‰ä»¥ä¸‹é—®é¢˜ï¼š

* æ‰‹æœºæ¸¸æˆä¸­ï¼Œæ¸¸æˆæ—¶é—´æ˜¯é›¶ç¢çš„ï¼Œæ‰€ä»¥å¾ˆå¤šæ¸¸æˆæ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¹Ÿå°±æ˜¯ä½ ä¸èƒ½åƒå¾ˆå¤šRPGç«¯æ¸¸æˆ–é¡µæ¸¸ä¸€æ ·å‡å®šä½ çœ‹åˆ°çš„è¿™ä¸ªç©å®¶ä¸€å®šåœ¨çº¿ã€‚
* ä½ æœ‰ä¸€ä¸ªå¥½å‹åˆ—è¡¨ï¼Œè¦æŸ¥çœ‹ä»–ä»¬çš„ç”¨æˆ·åå’Œç­‰çº§ï¼Œä½†æ˜¯ä½ çš„æ•°æ®æ²¡æœ‰åˆ†è¡¨å­˜å‚¨ï¼Œæ‰€ä»¥ä½ å¿…é¡»æŠŠæ•´ä¸ªç©å®¶æ•°æ®loadåˆ°å†…å­˜ä¸­ï¼Œè¿™ååˆ†ä¸ç»æµã€‚

åˆ†è¡¨å­˜å‚¨çš„æ„æ€æ˜¯ä¸åŒçš„æ¨¡å—æœ‰å•ç‹¬çš„æ•°æ®è¡¨ï¼Œæ¯”å¦‚å»ºç­‘è¡¨ï¼Œç©å®¶åŸºæœ¬ä¿¡æ¯è¡¨ï¼Œå¥½å‹è¡¨ï¼Œè¿™æ ·æœ‰ä»¥ä¸‹å¥½å¤„ã€‚

* çµæ´»çš„åŠ è½½ä½ éœ€è¦çš„ä»»ä½•ä¸€éƒ¨åˆ†æ•°æ®ï¼Œåªçœ‹åŸºæœ¬ä¿¡æ¯å°±åŠ è½½åŸºæœ¬è¡¨ï¼Œçœ‹å…¶å»ºç­‘ä¿¡æ¯å°±åŠ è½½å»ºç­‘è¡¨ä¸­ä»–çš„æ•°æ®ï¼Œéå¸¸çµæ´»ã€‚
* å¦‚æœä¸€ä¸ªç©å®¶ç™»é™†ï¼Œåªå‡çº§çš„ä¸€ä¸ªå»ºç­‘è€Œå·²ï¼Œé‚£æˆ‘åªéœ€è¦æ›´æ–°ä»–çš„å»ºç­‘è¡¨çš„ä¸€æ¡æ•°æ®è€Œå·²ï¼Œè€Œä¸æ˜¯å…¨éƒ¨ã€‚
* æ–¹ä¾¿è¿›è¡Œå†…å­˜æ¸…ç†ï¼Œå› ä¸ºä¸åŒæ¨¡å—çš„æ•°æ®æ´»è·ƒæ€§è´¨æœ‰å¯èƒ½ä¸ä¸€æ ·ï¼Œè¿™æ—¶å€™å¯ä»¥åˆ†åˆ«å¤„ç†ã€‚

æ‰€ä»¥æˆ‘é€‰æ‹©etsåœ¨å†…å­˜ä¸­å»ºç«‹Mysqlæ•°æ®è¡¨çš„cacheã€‚

## 3.2 ets cache
---
cacheæ˜¯è®¡ç®—æœºé‡Œä¸€ä¸ªå¾ˆæ™®éçš„æ¦‚å¿µï¼Œè¿™é‡Œçš„ç†è®ºæ€æƒ³æ˜¯ï¼šå†…å­˜ä¸­è¯»å–æˆ–è€…ä¿®æ”¹ä¸€ç‚¹æ•°æ®å¤§æ¦‚æ¯”ç¡¬ç›˜ä¸Šçš„è¯»å–ä¿®æ”¹å¿«10000å€ï¼Œä¿æŒå¤§é‡çš„æ“ä½œåœ¨å†…å­˜ä¸­è¿›è¡Œå°†æå¤§çš„æé«˜æœåŠ¡å™¨çš„ç›¸åº”é€Ÿåº¦ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªæ“ä½œï¼š

* è¯»å–ï¼šå…ˆåœ¨å¯¹åº”çš„ets cacheè¡¨ä¸­æŸ¥è¯¢ï¼Œå¦‚æœæ²¡æœ‰å†ä»Mysqlä¸­åŠ è½½ã€‚
* æ›´æ–°ï¼šå…ˆåœ¨etsè¡¨ä¸­æ›´æ–°ï¼Œäº§ç”Ÿä¸€ä¸ªæ›´æ–°äº‹ä»¶ç»™æŒä¹…åŒ–è¿›ç¨‹åŒæ­¥ã€‚
* æ–°å»ºï¼šç°åœ¨etsè¡¨ä¸­æ–°å»ºï¼Œäº§ç”Ÿä¸€ä¸ªæ–°å»ºäº‹ä»¶ç»™æŒä¹…åŒ–è¿›ç¨‹åŒæ­¥ã€‚
* åˆ é™¤ï¼šç°åœ¨etsè¡¨ä¸­åˆ é™¤ï¼Œäº§ç”Ÿä¸€ä¸ªåˆ é™¤äº‹ä»¶ç»™æŒä¹…åŒ–è¿›ç¨‹åŒæ­¥ã€‚

æ‰€ä»¥ï¼Œå¢åˆ æŸ¥æ”¹éƒ½å°½å¯èƒ½çš„åœ¨å†…å­˜ä¸­è¿›è¡Œäº†ã€‚ä¸‹é¢å…ˆå¯¹MySQlå±‚è¿›è¡Œæè¿°ã€‚

## 3.3 MySQlæŒä¹…åŒ–
---
å¯¹ç©å®¶æ•°æ®çš„å¤„ç†ä¸å¤–ä¹å¢åˆ æŸ¥çœ‹ï¼Œåˆ†åˆ«å¯¹åº”ç€Mysqlä¸­çš„insert, delete, select, updateå››ç§æ“ä½œã€‚
è¿™æ—¶å€™æœ‰ä¸¤éƒ¨åˆ†å·¥ä½œï¼Œåˆ†åˆ«æ˜¯SQLæ‹¼æ¥å’ŒSQLæ‰§è¡Œã€‚

### 3.3.1 SQL æ‹¼æ¥
---

SQLæ˜¯å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬çš„ç›®çš„é’ˆå¯¹ä¸åŒçš„æ“ä½œç¼–å†™erlangçš„æ¥å£æ¨¡å—ï¼Œè¿™æ ·ç›´æ¥åœ¨erlangæ¨¡å—å‡½æ•°ä¸Šæ“ä½œï¼Œè€Œä¸æ˜¯æ¯ä¸ªäººéƒ½è‡ªå·±ç”¨io_lib:formatæ‹¼æ¥ã€‚

è¿™ä¸ªæ¨¡å—çš„ä»£ç åœ¨[model_sql.erl](https://github.com/zhuoyikang/slg-model/blob/master/src/model_sql.erl)ï¼Œæˆ‘å°†åˆ†åˆ«å¯¹å…¶è¿›è¡Œè¯¦ç»†æè¿°ï¼š

```
%% æ‹¼æ¥è¡¨æ ¼çš„filedsåˆ—è¡¨, select @(name, type, level)ï¼Œåªæ¥å—åŸå­å‚æ•°.
k_column(S) when is_atom(S) -> "`"++ atom_to_list(S) ++ "`".

k_column_list(all) -> ["*"];
k_column_list([H]) ->
  H1 = k_column(H), [H1];
k_column_list([H|L]) ->
  H1 = k_column(H),
  [H1, ", "] ++ k_column_list(L).
k_column_list_test() ->
  ["*"] = k_column_list(all),
  ["`name`"] = k_column_list([name]),
  L = ["`name`", ", ", "`password`"] = k_column_list([name, password]),
  <<"`name`, `password`">> = list_to_binary(L),
  ok.  
```

å¦‚æ³¨é‡Šæ‰€è¨€ï¼Œk_column_listå‡½æ•°æ˜¯ä¸ºäº†æ»¡è¶³selectè¯­å¥ä¸­çš„æŸ¥è¯¢åˆ—è¡¨ï¼Œå½“ç„¶è¿˜æœ‰updateè¯­å¥ä¸­çš„æ›´æ–°åˆ—è¡¨ã€‚

```
%% æ‹¼æ¥è¯­å¥ä¸­å¯èƒ½å‡ºç°çš„valueåˆ—è¡¨ï¼Œåªæ¥å—æ•°å­—ï¼ŒäºŒè¿›åˆ¶å’Œåˆ—è¡¨
v_column(V) when is_integer(V) -> integer_to_list(V);
v_column(<<V/binary>>) -> <<$", V/binary, $">>;
v_column(V) when is_list(V) ->
  B = list_to_binary(V),
  <<$", B/binary, $">>.

v_column_list([H]) ->
  H1 = v_column(H), [H1];
v_column_list([H|L]) ->
  H1 = v_column(H),
  [H1, ", "] ++ v_column_list(L).
v_column_list_test() ->
  [<<"\"name\"">>] = v_column_list([<<"name">>]),
  L = [<<"\"name\"">>, ", ", <<"\"password\"">>] = v_column_list([<<"name">>, <<"password">>]),
  <<"\"name\", \"password\"">> = list_to_binary(L),
  ok.
```

v_column_listæ˜¯ä¸ºäº†å®ç°æ›´æ–°è¯­å¥ä¸­çš„æ›´æ–°æ•°æ®åˆ—è¡¨ã€‚

```
%% æ¡ä»¶è¯­å¥
condition({Key, in, ValueList}) ->
  [" WHERE "] ++ k_column(Key) ++ " IN (" ++ v_column_list(ValueList) ++ ")";
condition(all) ->
  [];
condition(Cond) ->
  [" WHERE "] ++ kv_column_value_list(" and ", Cond).
```

è¿™é‡Œæ˜¯ä¸€ä¸ªselectè¯­å¥çš„ä½¿ç”¨ä¾‹å­ï¼š

```
%% æ‹¼æ¥æŸ¥è¯¢è¯­å¥
select(Table, Column, Cond) ->
  L = "SELECT " ++ k_column_list(Column)  ++ from(Table) ++ condition(Cond) ++";",
  list_to_binary(L).
select_test() ->
  <<"SELECT `id`, `name` FROM `users` WHERE `id` = 23;">>
    = select(users, [id, name], [{id, 23}]).
```

ä¸€ä¸ªupdateæ“ä½œçš„ä¾‹å­ï¼š

```
%% æ‹¼æ¥æ›´æ–°è¯­å¥
update_test() ->
  <<"UPDATE `user` SET `name` = \"fe\", `value` = \"fewf\" WHERE `id` = 23;">>
    = update(user, [{name, <<"fe">>}, {value,  <<"fewf">>}], [{id, 23}]).
```

ä¸€ä¸ªdeleteçš„ä¾‹å­ï¼š

```
delete_test() ->
  <<"DELETE FROM `user` WHERE `id` = 23;">>
    = delete(user, [{id, 23}]),
  <<"DELETE FROM `user` WHERE `id` IN (1, 2, 3);">>
    = delete(user, {id, in, [1,2,3]}).
```

æ‰€ä»¥ï¼Œä½ å¯ä»¥çœ‹åˆ°å®ƒä»¬åªæ˜¯å­—ç¬¦ä¸²æ‹¼æ¥å¤„ç†è€Œå·²ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€æè¿°äº†ã€‚

### 3.3.2 SQL æ‰§è¡Œ
---
ä½¿ç”¨ç°æˆçš„[erlang-mysql-driver](https://github.com/dizzyd/erlang-mysql-driver.git)è¿›è¡Œï¼Œæˆ‘æŠŠæ‰§è¡Œæ“ä½œå°è£…åˆ°äº†[model_exec.erl](https://github.com/zhuoyikang/slg-model/blob/master/src/model_exec.erl)ã€‚

æ¯ä¸€ä¸ªå‡½æ•°éƒ½æœ‰ä»¥ä¸‹ä¸¤ç§APIï¼Œåˆ†åˆ«ä»¥_tå’Œ_nç»“å°¾ï¼š

```
%% ä¸æŒ‡å®špollï¼Œç”¨äºäº‹åŠ¡.
select_t(SQL) ->
select_t(RecordName, SQL) ->

%% æ‰§è¡Œselectè¯­å¥ã€‚
select_n(Poll, SQL) ->
select_n(Poll, RecordName, SQL) when is_atom(Poll) ->
â€¦
```

* _nç»“å°¾çš„å‡½æ•°å¯ä»¥åœ¨ç¬¬ä¸€å‚æ•°æŒ‡å®šè¿æ¥æ± .
* _tç»“å°¾çš„å‡½æ•°ç”¨äºäº‹åŠ¡æ“ä½œï¼Œè¿™æ˜¯erlang-mysql-driverçš„æ¥å£è§„èŒƒ:

å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨è¿‡erlang-mysql-driverï¼Œéœ€è¦è¯¦ç»†é˜…è¯»ä¸€ä¸‹ä¸€ä¸ªä¾‹å­ï¼š[erlang-mysql-driver-test](https://github.com/dizzyd/erlang-mysql-driver/blob/master/test/mysql_test.erl)

è¿™é‡Œæ˜¯slg-serverçš„ä¾èµ–é…ç½®ï¼š[rebar.config](https://github.com/zhuoyikang/slg-model/blob/master/config/rebar.config)

### 3.3.3 ç»„åˆæ“ä½œ
---

æ—¢ç„¶æœ‰SQlæ‹¼æ¥å’ŒSQLæ‰§è¡Œï¼Œå°±å¯ä»¥ç¼–å†™å‡ºå®Œæ•´çš„å¢åˆ æŸ¥æ”¹æ¥å£å‡½æ•°:[model.erl](https://github.com/zhuoyikang/slg-model/blob/master/src/model.erl)

```
%% å¼€å¯ä¸€ä¸ªpoll
start(DbsConf) ->
  #db_conf{poll=Poll, host=HostName, port=Port, username=UserName,
           password=Password, database=DataBase, worker=Worker} = DbsConf,
  mysql:start_link(Poll, HostName, Port, UserName, Password, DataBase, fun logger/4),
  [mysql:connect(Poll, HostName, undefined, UserName, Password, DataBase, true) ||
    _ <- lists:seq(1, Worker)],
  Poll.
```
è¿™é‡Œæ˜¯ä½¿ç”¨erlang-mysql-driverå¼€å¯ä¸€ä¸ªè¿æ¥æ± ï¼Œä½¿ç”¨æ–¹æ³•å¯ä»¥çœ‹erlang-mysql-driverçš„æ–‡æ¡£æˆ–è€…æºç ã€‚

ä½ å¯ä»¥çœ‹åˆ°ï¼Œä»…ä»…æ˜¯ç»„åˆè€Œå·²ï¼š

```
select_t(Record, Table, Column, Cond) ->
  SQL = model_sql:select(Table, Column, Cond),
  model_exec:select_t(Record, SQL).

select_n(Poll, Record, Table, Column, Cond) ->
  SQL = model_sql:select(Table, Column, Cond),
  model_exec:select_n(Poll, Record, SQL).
  
â€¦ çœç•¥  
```

## 3.4 åŠ¨æ€modelæ¨¡å—
---
slg-modelä¼šä¸ºæ¯ä¸€ä¸ªMySqlè¡¨äº§ç”Ÿä¸€ä¸ªåŠ¨æ€çš„erlangæ¨¡å—ï¼Œä½¿ç”¨äº†[smerl](https://github.com/yariv/erlyweb/blob/master/src/smerl/smerl.erl)å¤„ç†ï¼Œå®ƒæ¥æºäº[erlyweb](https://github.com/yariv/erlyweb?source=c)é¡¹ç›®ï¼Œä¸ºerlangæä¾›äº†åŸºç¡€çš„åŠ¨æ€ç¼–ç¨‹èƒ½åŠ›ï¼Œéå¸¸å¥½ç”¨ã€‚

ä½¿ç”¨ä¾‹å­ï¼š

```
%%  test_smerl() ->
%%    M1 = smerl:new(foo),
%%    {ok, M2} = smerl:add_func(M1, "bar() -> 1 + 1."),
%%    smerl:compile(M2),
%%    foo:bar(),   % returns 2``
%%    smerl:has_func(M2, bar, 0). % returns true
```

æˆ‘æŠŠè¿™ä¸ªæ¨¡å—æ”¶å½•åˆ°äº†[slg-support](https://github.com/zhuoyikang/slg-support)é¡¹ç›®ã€‚

ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå®ä½“çš„è¡¨modelæ¨¡å—ä¾‹å­:[model_buildings.erl](https://github.com/zhuoyikang/slg-model/blob/master/src/model_building.erl)

å¯ä»¥çœ‹å‡ºå‡½æ•°åˆ†æˆäº‹åŠ¡å’Œéäº‹åŠ¡ä¸¤ç»„ï¼š

```
select(Poll, Cond) when is_list(Cond) ->
  model:select_n(Poll, db_building, buildings, all, Cond);
select(Poll, UserId) ->
  model:select_n(Poll, db_building, buildings, all, [{user_id, UserId}]).

%% é€šè¿‡å¤–é”®æŸ¥è¯¢
select(Cond) when is_list(Cond) ->
  model:select_t(db_building, buildings, all, Cond);
select(UserId) ->
  model:select_t(db_building, buildings, all, [{user_id, UserId}]).

```

updateæ“ä½œæœ‰ä¸¤ä¸ªï¼Œå…¶ä¸­ç¬¬2ä¸ªupdate(Poll, DbBuilding)ç›´æ¥ä½¿ç”¨ä¸æ•°æ®è¡¨å¯¹åº”çš„recordå®ä½“åšå‚æ•°ã€‚

```
update(Poll, {Id, List}) ->
  List1 = model:pos_attr(model_record:m(buildings), List),
  model:update_n(Poll, Id, buildings, List1);
update(Poll, DbBuilding) ->
  model:update_n(Poll, model_record:m(buildings), buildings, DbBuilding).
```

## 3.5 Ets Record MySqlæ˜ å°„
---
ä¸Šæ–‡å·²ç»æè¿°è¿‡ï¼Œæ¯ä¸ªetsè¡¨å°†å¯¹åº”ä¸€ä¸ªMySqlè¡¨ï¼Œè€ŒMySqlè¡¨çš„å­—æ®µç»“æ„å°†ç”±ä¸€ä¸ªrecordæ¥æè¿°ï¼Œè¿™ä¸ªrecordå°†å­˜å‚¨åˆ°etsé‡Œã€‚

æ¯”å¦‚æœ‰ä»¥ä¸‹MySqlè¡¨ï¼Œusers:

```
+------------+-------------+------+-----+---------+-------+
| Field      | Type        | Null | Key | Default | Extra |
+------------+-------------+------+-----+---------+-------+
| id         | bigint(20)  | NO   | PRI | NULL    |       |
| user_id    | bigint(20)  | NO   |     | NULL    |       |
| device_id  | int(11)     | NO   |     | NULL    |       |
| name       | varchar(30) | NO   | UNI | NULL    |       |
| level      | int(11)     | NO   |     | NULL    |       |
| experience | int(11)     | NO   |     | 0       |       |
| sex        | tinyint(4)  | NO   |     | -1      |       |
+------------+-------------+------+-----+---------+-------+
```

å°†æœ‰ä¸€ä¸ªä¸å…¶å¯¹åº”çš„record:

```
%% # ç©å®¶åŸºæœ¬ä¿¡æ¯
-record(db_user, {
          id = <<"0">> :: binary(),
          user_id = <<"0">> :: binary(),
          device_id = <<"0">> :: binary(),
          name = <<"">> :: binary(),
          level = 0 :: integer(),
          experience = 0 :: integer(),
          sex = 0 :: integer()
         }).
```

slg-modelçº¦å®šä¸€ä¸ªè¡¨é‡‡ç”¨å¤æ•°ï¼Œæ¯”å¦‚usersï¼Œè€Œå…¶å¯¹åº”çš„recordä½¿ç”¨db_å‰ç¼€åŠ ä¸Šå…¶å•æ•°è¡¨ç¤º:db_userï¼ŒåŠ¨æ€æ¨¡å—ä½¿ç”¨model_åŠ ä¸Šè¡¨åå­—(model_users)ã€‚

ä½ å¯ä»¥çœ‹åˆ°è¿™ä¸ªdb_user recordå’ŒMySqlè¡¨çš„æ¯ä¸ªå­—æ®µä¸€ä¸€å¯¹åº”ï¼Œå¦å¤–è¿˜æœ‰ä¸¤ç‚¹æ³¨æ„ï¼š

* id:idæ˜¯è¡¨çš„ä¸»é”®ï¼Œè¿™é‡Œé‡‡ç”¨bigintï¼Œå› ä¸ºè€ƒè™‘åˆ°åˆæœçš„æƒ…å†µï¼Œç¨‹åºä¿ç•™æ¯ä¸ªä¸»é”®æ•°å­—çš„å3ä½ä¸ºæœåŠ¡å™¨æ ‡è¯†ï¼Œè¿™æ ·å°±ç®—æœ‰å¤šä¸ªæœåŠ¡å™¨ä¹Ÿä¸ä¼šæœ‰idå†²çªï¼Œåˆæœçš„æ—¶å€™åªéœ€è¦åšè¡¨åˆå¹¶å³å¯ã€‚
* varchar:å­—ç¬¦ä¸²ç±»å‹åœ¨ç¨‹åºä¸­ä¸€å¾‹ä½¿ç”¨binaryç±»å‹æè¿°ï¼Œå› ä¸ºerlangå¯¹å­—ç¬¦ä¸²æ”¯æŒä¸å¥½ï¼Œè€Œä¸”å¦‚æœè®¾è®¡åˆ°å¤šè¯­è¨€é—®é¢˜ï¼Œlistæ›´æ˜¯æ²¡æœ‰åŠæ³•è¡¨è¾¾ï¼Œæ‰€ä»¥åªæœ‰ç”¨binaryã€‚

æ‰€ä»¥åŠ¨æ€æ¨¡å—çš„updateå‡½æ•°ä¸­æœ‰ä¸€ä¸ªç›´æ¥ä½¿ç”¨DbRecordä¸ºå‚æ•°ï¼Œå®ƒå°†è¿™ä¸ªrecordé‡Œå¤´æ‰€æœ‰çš„æ•°æ®æ›´æ–°åˆ°MySQLã€‚

## 3.6 data_holder
---
æ¯ä¸ªetsè¡¨éƒ½è¦æœ‰ä¸€ä¸ªæ‹¥æœ‰è€…ï¼Œè¿™ä¹Ÿæ˜¯[data_holder](https://github.com/zhuoyikang/slg-model/blob/master/src/data_holder.erl)è¿›ç¨‹å­˜åœ¨çš„ä¸»è¦ä½œç”¨ã€‚

å®ƒçš„ä»£ç å¾ˆç®€å•ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªéƒ¨åˆ†éœ€è¦æ³¨æ„ï¼š

*init å‡½æ•°*

```
init([Dbc, Key]) ->
  data_ets:new(Key),
  model:module_new(Key),
  model:start(Dbc#db_conf{poll=model:atom_poll(Key, read), worker=3}),
  model:start(Dbc#db_conf{poll=model:atom_poll(Key, write), worker=1}),
  MaxId = max_id(model:atom_poll(Key, read), Key),
  data_guard_super:start_guard(Key),
  data_writer_super:start_writer(Key),
  data_clear_super:start_clear(Key),
  {ok, {Key, MaxId, Dbc}}.
```

data_holderlè¿›ç¨‹å¯åŠ¨æ—¶å°†ï¼š

* 1.å»ºç«‹etsè¡¨ã€‚
* 2.å»ºç«‹åŠ¨æ€æ¨¡å—ã€‚
* 3.å¼€èµ·ä¸¤ä¸ªè¿æ¥æ± ï¼Œåˆ†åˆ«ç”¨äºå¯¹MySQlçš„è¯»å†™ã€‚
* 4.å¼€å¯ä¸€ä¸ªguardè¿›ç¨‹ã€‚
* 5.å¼€å¯ä¸€ä¸ªMySqlå›å†™è¿›ç¨‹ã€‚
* 6.å¼€å¯ä¸€ä¸ªæ•°æ®æ¸…ç†è¿›ç¨‹ã€‚

è¿™ä¸ªè¿›ç¨‹é‡Œé¢å¼•å…¥äº†3ä¸ªè¿˜æ²¡æœ‰æè¿°çš„ä¸œè¥¿ï¼šguardï¼Œwriterå’Œclearï¼Œä¹‹åä¼šå¯¹å®ƒä»¬è¿›è¡Œè¯¦ç»†æè¿°ã€‚

*IDå‡½æ•°* 

```
id(Key) ->
  Atom = model:atom(holder, Key),
  gen_server:call(Atom, id).
```

æ¯ä¸ªdata_holderè¿›ç¨‹å°†æä¾›idç”ŸæˆåŠŸèƒ½ï¼Œå®ƒå°†ç”¨äºä¸ºæ¯ä¸ªè¡¨äº§ç”Ÿå”¯ä¸€idã€‚


















